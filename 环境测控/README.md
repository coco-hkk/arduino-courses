# 环境测控

使用传感器检测环境，包括温湿度、PM2.5、光照强度、CO 浓度、土壤湿度和障碍物距离。
使用三块 Arduino UNO、ESP8266MOD 和 ESP-12E 三块 MCU 实现数据采集并显示，通过分
析数据实现遥控其它硬件。无操作系统。

# 环境

- win10 64
- Arduino IDE 1.8.15
- ArduinoJson 6.18.0
- ArduinoStreamUtils 1.6.1

# MCU 任务

三块 MCU 分工不同。Arduino UNO 仅仅负责采集传感器数据，通过软串口通信方式将数据
传输给另外两块 MCU；ESP8266MOD 负责搭建一个服务器，显示从 UNO 板子获取的传感器数
据，同时提供一个用于控制硬件的页面；ESP-12E 作为客户端负责和 Adafruit 服务器交互
，将获取的传感器数据发布到 Adafruit，并订阅 Adafruit 创建的用于控制 ESP-12E 外设
的主题。

## Arduino Uno

采集温湿度、PM2.5、光照强度、CO 浓度、土壤湿度和障碍物距离数据，分析数据，将结果
通过串口发送给其它设备。

涉及软串口通信：
- 注意三块设备之间串口通信频率保持一致，均为 9600。
- 由于设备间传输的数据不大，所以适用静态分配缓存，且都保持一致，为 1KB。
- 代码中的串口通信方式，在每次发送或接收完消息，退出函数后自动销毁分配的缓存。
- 采集传感器数据不要过于频繁。一方面考虑接收端可能来不及接收，另一方面 Adafruit
  对数据上传太频繁做了警告，实验测试 20s 采集一次比较合适。

### 温湿度传感器

1. 使用管脚 D3，该管脚为 PWM 管脚。
    - VCC： +5V
    - DAT： D3
    - GND： GND

### 光敏电阻

1. 串联一个 10K 电阻，使用管脚 A0。

    |      |      |         |
    | :-:  | :-:  |   :-:   |
    | GND  | 电阻 |   A0    |
    | +5V  | 光敏 |   A0    |
    | 光敏 |  ->  |  电阻   |

### 土壤湿度传感器

1. 使用管脚 A1 和 D2。
    - AO： A1
    - DO： D2

### 超声波测距传感器

1. 使用管脚 D5 和 D4。
    - Trig： D5
    - Echo： D4

### MQ-9 可燃气体传感器

1. 使用管脚 D7 和 A2。
    - DO： D7
    - AO： A2

2. 正常需要预热和校准 15 分钟，本例只简单的测试 100 次取均值。

### PM2.5 传感器

未找到 GP2Y10 PM2.5 传感器 fritzing parts，电路图中没有 PM2.5 传感器。

1. 使用管脚 D8 和 A3。

    | 导线编号 |            | Arduino |
    |   :-:    |    :-:     |   :-:   |
    |    1     |   150Ω    |   +5V   |
    |    1     | 220μF电容 |   GND   |
    |    2     |     ->     |   GND   |
    |    3     |     ->     |   D8    |
    |    4     |     ->     |   GND   |
    |    5     |     ->     |   A3    |
    |    6     |     ->     |   +5V   |

### 软串口

1. 使用 D10 和 D11 管脚。
    - RX： D10
    - TX： D11

### Arduino UNO 重启

没有直接重启的函数，使用一个 1KΩ 电阻将 12 引脚和 RESET 引脚相连，然后向 12 引
脚写入低电平实现重启。

1. 使用管脚 D12。


## ESP8266MOD

创建服务器，从软串口获取传感器数据并在服务器提供的网页中显示。另一方面，服务器提
供了可供用户控制 MCU 外围硬件的页面。包括开关 LED、重启服务器、重启 Arduino UNO
板子、播放音乐、控制舵机旋转角度。

### LED

1. 使用管脚 D0 控制 LED。

### 音乐播放

通过蜂鸣器实现音乐播放。在播放音乐的同时，根据节奏变换不同颜色的 RGB LED。

1. 使用管脚 D4 控制蜂鸣器。
2. 使用管脚 D1~D3 控制 RGB 三基色 LED。
    - R： D1
    - G： D2
    - B： D3

### 重启 ESP8266 或 Arduino Uno

1. ESP8266 通过 ESP 提供的函数 `ESP.restart` 实现重启。
2. Arduino Uno 重启，是通过软串口将重启指令发送到 Arduino UNO 侧实现。

### 红外遥控

通过红外遥控控制 Arduino UNO 和 ESP8266MOD 重启。

1. 使用 D7 管脚
    - OUT： D7

### 舵机

单独控制舵机旋转没意义，可以把它作为温度仪表盘的指针就有控制的意义了（虽然没去实
现这个想法）。

1. 使用管脚 D8。

### 软串口

1. 使用 D5 和 D6 管脚
    - RX： D5
    - TX： D6

## NodeMCU(ESP-12E)

连接 adafruit 服务器，发布从软串口获取的传感器数据，在 Adafruit 创建显示各种传感
器数据的控件。在 Adafruit 创建一个可以控制 LED 的开关控件，创建一个可以输入文本
的控件，然后 NodeMCU 订阅这两个控件消息。

输入文本框可以用于控制 LCD 显示屏显示文本框内的内容，仅限 ASCII 字符。实现从
Adafruit 控制 LCD 功能。

在接收软串口数据时：
1. 若是提示 InvalidInput，这是接收速度不够快导致的。改进方法是每次取 64 个字节提
   高速度。
2. 若是提示 IncompleteInput，这是由于读取数据超时。在 deserializeJson 之前更改超
   时 `Serial.setTimeout(10000);`，其中 `Serial` 是你代码中所使用的串口。

### LED

1. 使用管脚 D6。

### LCD

1. 使用管脚 D0~D5。
   - RS： D0
   - EN： D1
   - D4： D2
   - D5： D3
   - D6： D4
   - D7： D5
   - RW： GND
   - VO： 电位器
   - VDD、A： +5V
   - VSS、K： GND

### 软串口

1. 使用 D7 和 D8 管脚
    - RX： D7
    - TX： D8

# 总结

这个只是个简单的数据收集显示和硬件控制，在此基础上可以做出更加复杂的功能。不足点
：
1. 没用 RTC，无法使用计时功能，所以只要有延时的地方，就只能浪费时间了。导致服务
   器网页无法正常刷新，串口收发问题。
2. 串口收发消息未采用队列方式，消息容易丢失。

